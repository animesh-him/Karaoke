<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audio Converter</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Pacifico&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  min-height:100vh;
  font-family:Poppins,sans-serif;
  color:white;
  background:linear-gradient(270deg,#ff00cc,#3333ff,#00ffd5);
  background-size:600% 600%;
  animation:bg 12s ease infinite;
}
@keyframes bg{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.container{
  max-width:420px;
  margin:auto;
  padding:20px;
  text-align:center;
}
button,input{
  width:100%;
  margin:10px 0;
}
button{
  padding:12px;
  border:none;
  border-radius:20px;
  background:rgba(255,255,255,.2);
  color:white;
  font-size:14px;
}
audio{width:100%}
.footer{
  margin-top:25px;
  font-family:Pacifico,cursive;
  opacity:.8;
}
</style>
</head>

<body>
<div class="container">
  <h2>Instrumental & Piano Converter</h2>
  <input type="file" id="file" accept="audio/*">
  <button id="inst" disabled>Create Instrumental</button>
  <audio id="instOut" controls></audio>
  <button id="piano" disabled>Create Piano Version</button>
  <audio id="pianoOut" controls></audio>
  <div class="footer"><i>created by Animesh</i></div>
</div>

<script>
const ctx = new AudioContext();
let buffer;

file.onchange = async e=>{
  const arr = await e.target.files[0].arrayBuffer();
  buffer = await ctx.decodeAudioData(arr);
  inst.disabled = piano.disabled = false;
};

/* -------- REAL MID/SIDE VOCAL REDUCTION -------- */
inst.onclick = ()=>{
  const off = new OfflineAudioContext(
    2, buffer.length, buffer.sampleRate
  );

  const src = off.createBufferSource();
  src.buffer = buffer;

  const splitter = off.createChannelSplitter(2);
  const merger = off.createChannelMerger(2);

  src.connect(splitter);

  // L - R
  const inv = off.createGain();
  inv.gain.value = -1;

  splitter.connect(inv,1);
  splitter.connect(merger,0);
  inv.connect(merger,0);

  splitter.connect(inv,0);
  splitter.connect(merger,1);
  inv.connect(merger,1);

  merger.connect(off.destination);
  src.start();

  off.startRendering().then(b=>play(b,instOut));
};

/* -------- MOVING PIANO MELODY -------- */
piano.onclick = ()=>{
  const off = new OfflineAudioContext(1, buffer.length, buffer.sampleRate);
  const data = buffer.getChannelData(0);
  let t = 0;

  for(let i=0;i<data.length;i+=buffer.sampleRate/4){
    const slice = data.slice(i,i+1000);
    const energy = slice.reduce((a,b)=>a+Math.abs(b),0)/slice.length;
    const freq = 220 + energy*800;

    const osc = off.createOscillator();
    osc.type="triangle";
    osc.frequency.setValueAtTime(freq,t);

    const g = off.createGain();
    g.gain.setValueAtTime(0.2,t);
    g.gain.exponentialRampToValueAtTime(0.001,t+0.25);

    osc.connect(g).connect(off.destination);
    osc.start(t);
    osc.stop(t+0.25);

    t+=0.25;
  }

  off.startRendering().then(b=>play(b,pianoOut));
};

function play(buf,el){
  const s = ctx.createBufferSource();
  s.buffer = buf;
  const d = ctx.createMediaStreamDestination();
  s.connect(d);
  s.start();
  el.srcObject = d.stream;
}
</script>
</body>
</html>
